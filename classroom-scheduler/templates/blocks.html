<!DOCTYPE html>
<html>
<head>
  <title>Session Length & Schedule</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link href="/static/css/blocks.css" rel="stylesheet">
</head>
<body>
<div class="container">
  <h1>Daily Schedule Configuration</h1>
  <p class="subtitle">Set default session length and break time — all classrooms follow this schedule</p>

  <form method="POST" action="/blocks/save">
    <div class="settings">
      <div class="setting">
        <strong>Session Length</strong><br>
        <input type="number" id="length" name="session_length" min="20" max="300" value="{{.DefaultSessionLength}}" onchange="updateSchedule()">
        <small>minutes</small>
      </div>
      <div class="setting">
        <strong>Break Time</strong><br>
        <input type="number" id="break" name="break_minutes" min="0" max="120" value="{{.BreakMinutes}}" onchange="updateSchedule()">
        <small>minutes</small>
      </div>
    </div>

    <div class="controls">
        <div style="margin-bottom:1.5rem;">
            <strong>Number of Classrooms:</strong>
            <input type="number" name="num_classrooms" min="1" max="30" value="{{.NumClassrooms}}" required 
                style="width:90px;padding:0.8rem;font-size:1.2em;margin-left:10px;">
            <em>← total rooms in the school</em>
        </div>
        <div>
            <strong>Number of Sessions:</strong>
            <input type="number" name="block_count" min="1" max="20" value="{{.BlockCount}}" required 
                style="width:90px;padding:0.8rem;font-size:1.2em;margin-left:10px;">
            <em>← sessions in the daily schedule</em>
        </div>
    </div>

    <table>
      <tr><th>Session</th><th>Start Time</th><th>End Time</th></tr>
      {{range $i, $b := .Blocks}}
      <tr>
        <td><strong>Session {{$b.ID}}</strong></td>
        <td><input type="text" class="timepicker" name="start_{{$b.ID}}" value="{{$b.StartTime}}" required></td>
        <td><input type="text" class="timepicker" name="end_{{$b.ID}}" value="{{$b.EndTime}}" required></td>
      </tr>
      {{end}}
    </table>

    <div style="text-align:center;">
      <button type="submit">SAVE SCHEDULE</button>
    </div>
  </form>

  <div class="back">
    <a href="/config">Classroom Configuration</a> • 
    <a href="/">Classrooms List</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  // Initialize Flatpickr AFTER the DOM is fully loaded
  document.addEventListener("DOMContentLoaded", function() {
    flatpickr(".timepicker", {
      enableTime: true,
      noCalendar: true,
      dateFormat: "H:i",
      time_24hr: true,
      minuteIncrement: 5,
      allowInput: true,
    });
  });

  // Your existing auto-cascade script (unchanged)
  function updateSchedule() {
    const length = parseInt(document.getElementById('length').value) || 80;
    const breakM = parseInt(document.getElementById('break').value) || 10;
    let prevEnd = null;
    document.querySelectorAll('table tr').forEach((row, i) => {
      if (i === 0) return;
      const startInput = row.querySelector('input[name^="start_"]');
      const endInput = row.querySelector('input[name^="end_"]');
      if (!startInput) return;

      let startTime = startInput.value;
      if (!startTime && prevEnd) {
        const d = new Date(`2020-01-01 ${prevEnd}:00`);
        d.setMinutes(d.getMinutes() + breakM);
        startTime = d.toTimeString().slice(0,5);
        startInput.value = startTime;
        startInput._flatpickr.setDate(startTime, true);
      }

      if (startTime) {
        const [h, m] = startTime.split(':').map(Number);
        const d = new Date();
        d.setHours(h, m, 0, 0);
        d.setMinutes(d.getMinutes() + length);
        const endH = String(d.getHours()).padStart(2,'0');
        const endM = String(d.getMinutes()).padStart(2,'0');
        if (!endInput.value || endInput.value === endInput.defaultValue) {
          endInput.value = endH + ':' + endM;
          if (endInput._flatpickr) endInput._flatpickr.setDate(endH + ':' + endM, true);
        }
        prevEnd = endH + ':' + endM;
      }
    });
  }
</script>
</body>
</html>